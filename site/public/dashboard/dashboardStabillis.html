<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.4/font/bootstrap-icons.css">
  <link rel="stylesheet" href="../css/dash.css">
  <script src="../js/funcoes.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>

<body>
  <nav class="side-menu" id="sideMenu">


    <ul>
      <li class="itens-menu">
        <a href="perfilUsuario.html">
            <span class="icon"><i class="bi bi-person"></i></span>
            <span class="txt">Perfil</span>
        </a>
    </li>
    <li class="itens-menu">
        <a href="../suporte.html">
            <span class="icon"><i class="bi bi-columns-gap"></i></span>
            <span class="txt">Suporte</span>
        </a>
    </li>
    <li class="itens-menu">
        <a href="../recuperacaoSenha.html">
            <span class="icon"><i class="bi bi-gear"></i></span>
            <span class="txt">Alterar Senha</span>
        </a>
    </li>
    <li class="itens-menu">
        <a href="../index.html">
            <span class="icon"><i class="bi bi-house"></i></span>
            <span class="txt">Sair</span>
        </a>
    </li>
  </nav>

  <!-------Fim da sidebar------>



  <!--Inicio dos gráficos -->
  <main>

    <!--Calendario-->
    <!-- <div class="data">
            <input type="date">
        </div> -->

    <!--KPIs-->
    <div class="container">
      <div class="coluna-kpi">
        <div class="card-perigo">
          <p>Perigo</p>
        </div>
        <div class="card-atencao">
          <p>Atenção</p>
        </div>
        <div class="card-estavel">
          <p>Estável</p>
        </div>
      </div>


      <!-- legendas KPI-->

      <div class="legenda-kpi">
        <div class="kpi">
          <div class="circuloverde"></div>
          <span>Tempo de atividade da máquina</span>
          <br><br>
          <p><b>10:05:25</b></p>
        </div>
      </div>
    </div>

    <!--fim legenda -->
    <div class="container-botao">
      <select name="opceos" id="">
      
      </select>
    </div>
    <!--Colunas da dash-->
    <div class="dashboard">

      <div class="graficos">
        
        <div class="status">
          <p>Uso de memória RAM</p>
          <div>
            <canvas id="grafico4" style="width: 50%;"></canvas>
          </div>
        </div>

        <div class="status">
          <p>Total disponível do Disco</p>
          <div>
            <canvas id="grafico5" style="width: 50%;"></canvas>
          </div>
        </div>

      </div>

      <div class="graficos">

        <div class="status">
          <p>Pacotes enviados e recebidos da máquina</p>
          <div>
            <canvas id="grafico" style="width: 600px; height: 200px;"></canvas>
          </div>
        </div>
        
        <div class="status">
          <p>Taxa de transferência do disco</p>
          <div>
            <canvas id="grafico2" style="width: 600px; height: 200px;"></canvas>
          </div>
        </div>

        <div class="status">
          <p>Em uso CPU</p>
          <div>
            <canvas id="grafico3" style="width: 600px; height: 200px;"></canvas>
          </div>
        </div>

      </div>
    </div>
    <!-- <div class="dashboard">
      <div class="painel1" id="painel1">
        <span><i class="bi bi-file-bar-graph-fill"></i></span>
        <div class="conteudo">
          <div class="legenda">
            <h3>Definir</h3>
            <h1>Definir</h1>
          </div>
          
          <div class="status">
            <div>
              <canvas id="grafico2" style="width: 100px; height: 100px;"></canvas>
            </div>
            <div class="percentual">
              <p>80%</p>
            </div>
          </div>
        </div>
        <small class="mini-legenda">Últimas 24 Horas</small>
      </div>
    </div>
    <div class="columns-dash">
      
      <!--fim do 1º coluna-->
<!-- 
    <div class="painel2" id="painel2">
      <span><i class="bi bi-pie-chart-fill"></i></span>
      <div class="conteudo">
        <div class="legenda">
          <h3>Definir</h3>
          <h1>Definir</h1>
        </div>
      </div>
      <small class="mini-legenda">Últimas 24 Horas</small>
    </div> -->

    <!--fim da 2ºcoluna-->

    <!-- <div class="painel3" id="painel3">
      <span><i class="bi bi-graph-up-arrow"></i></span>
      <div class="conteudo">
        <div class="legenda">
          <h3>Definir</h3>
          <h1>Definir</h1>
        </div>
        <div class="status">
          <canvas id="grafico3" style="width: 100px; height: 100px;"></canvas>
          <div class="percentual">
            <p>80%</p>
          </div>
        </div>
      </div>
      <small class="mini-legenda">Últimas 24 Horas</small>
    </div> -->

    <!--fim da 3º coluna-->

    <!-- <div class="painel4" id="painel4">
      <span><i class="bi bi-bar-chart-line-fill"></i></span>
      <div class="conteudo">
        <div class="legenda">
          <h3>Definir</h3>
          <h1>Definir</h1>
        </div>
        <div class="status">
          <canvas id="grafico4" style="width: 100px; height: 100px;"></canvas>
          <div class="percentual">
            <p>80%</p>
          </div>
        </div>
      </div>
      <small class="mini-legenda">Últimas 24 Horas</small>
    </div>

    fim da 4ºcoluna -->

    <!-- <div class="painel5" id="painel5">
      <span><i class="bi bi-file-bar-graph-fill"></i></span>
      <div class="conteudo">
        <div class="legenda">
          <h3>Definir</h3>
          <h1>Definir</h1>
        </div>
        <div class="status">
          <span><img src="" alt="">imagem
          </span>
          <div class="percentual">
            <p>80%</p>
          </div>
        </div>
      </div>
      <small class="mini-legenda">Últimas 24 Horas</small>
    </div>



    fim da 5ºcoluna -->

    <!-- <div class="painel6" id="painel6">
      <span><i class="bi bi-file-bar-graph-fill"></i></span>
      <div class="conteudo">
        <div class="legenda">
          <h3>Definir</h3>
          <h1>Definir</h1>
        </div>
        <div class="status">
          <span><img src="" alt="">imagem
          </span>
          <div class="percentual">
            <p>80%</p>
          </div>
        </div>
      </div>
      <small class="mini-legenda">Últimas 24 Horas</small>
    </div>


    fim da 6ºcoluna -->
    </div>


  </main>


  <script>
    var idMaquina = 3;
    window.onload = obterdadosGrafico(3);

function obterdadosGrafico(idMaquina) {


fetch(`/medidas/ultimas/${idMaquina}`, { cache: 'no-store' }).then(function (response) {
    if (response.ok) {
        response.json().then(function (resposta) {
            console.log(`dados recebidos: ${JSON.stringify(resposta)}`);
            resposta.reverse();

            plotarGrafico(resposta, idMaquina);

        });
    } else {
        console.error('Nenhum dado encontrado ou erro na API');
    }
})
    .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
    });
}

// Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
// Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
// A função *plotarGrafico* também invoca a função *atualizarGrafico*
function plotarGrafico(resposta, idMaquina) {
  console.log('Iniciando plotagem do gráfico...');

  const ctx = document.getElementById('grafico');
  let labels = [];

  var chartData = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Pacotes enviados',
        data: [],
        borderWidth: 1
      }, {
        label: 'Pacotes recebidos',
        data: [],
        borderWidth: 1
      }]
    },
    options: {
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });

  for (i = 0; i < resposta.length; i++) {
    var registro = resposta[i];
    console.log(registro.pacotesRecebidos);
    chartData.data.datasets[0].data.push(registro.pacotesEnviados);
    chartData.data.datasets[1].data.push(registro.pacotesRecebidos);
    labels.push(registro.dh)
  }
  chartData.update();

}
 
    function atualizarGrafico(idMaquina, dados, myChart) {



fetch(`/medidas/tempo-real/${idMaquina}`, { cache: 'no-store' }).then(function (response) {
    if (response.ok) {
        response.json().then(function (novoRegistro) {

            console.log(`dados recebidos: ${JSON.stringify(novoRegistro)}`);
            console.log(`dados atuais do gráfico:`);
            console.log(dados);

            let avisoCaptura = document.getElementById(`avisoCaptura${idMaquina}`)
            avisoCaptura.innerHTML = ""


            if (novoRegistro[0].dh == dados.labels[dados.labels.length - 1]) {
                console.log("---------------------------------------------------------------")
                console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                avisoCaptura.innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
                console.log("Horário do novo dado capturado:")
                console.log(novoRegistro[0].dh)
                console.log("Horário do último dado capturado:")
                console.log(dados.labels[dados.labels.length - 1])
                console.log("---------------------------------------------------------------")
            } else {
                // tirando e colocando valores no gráfico
                dados.labels.shift(); // apagar o primeiro
                dados.labels.push(novoRegistro[0].dh); // incluir um novo momento

                dados.datasets[0].data.shift();  // apagar o primeiro de umidade
                dados.datasets[0].data.push(novoRegistro[0].pacotesRecebidos); // incluir uma nova medida de umidade

                dados.datasets[1].data.shift();  // apagar o primeiro de temperatura
                dados.datasets[1].data.push(novoRegistro[0].pacotesEnviados); // incluir uma nova medida de temperatura

                myChart.update();
            }

            // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
            proximaAtualizacao = setTimeout(() => atualizarGrafico(idMaquina, dados, myChart), 2000);
        });
    } else {
        console.error('Nenhum dado encontrado ou erro na API');
        // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
        proximaAtualizacao = setTimeout(() => atualizarGrafico(idMaquina, dados, myChart), 2000);
    }
})
    .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
    });

}
    const ctx2 = document.getElementById('grafico2');

    new Chart(ctx2, {
      type: 'line',
      data: {
        labels: ['12:10:15', '12:10:25', '12:10:35', '12:10:45', '12:10:55', '12:11:05'],
        datasets: [{
          label: 'Valor em MiB',
          data: [1224123, 634523, 804239, 536123, 357192, 936481],
          borderWidth: 1
        }]
      },
      options: {
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
    const ctx3 = document.getElementById('grafico3');

    new Chart(ctx3, {
      type: 'line',
      data: {
        labels: ['12:10:15', '12:10:25', '12:10:35', '12:10:45', '12:10:55', '12:11:05'],
        datasets: [{
          label: 'Uso em %',
          data: [52, 49, 63, 78, 63, 57],
          borderWidth: 1
        }]
      },
      options: {
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });

    const ctx4 = document.getElementById('grafico4');

    new Chart(ctx4, {
      type: 'pie',
      data: {
        labels: ['% Disponível', '% Em uso'],
        datasets: [{
          label: ['% Disponível', '% Em uso'],
          data: [23, 77],
          borderWidth: 1
        }]
      },
      options: {
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });

    const ctx5 = document.getElementById('grafico5');

    new Chart(ctx5, {
      type: 'pie',
      data: {
        labels: ['% Disponível', '% Em uso'],
        datasets: [{
          label: ['% Disponível', '% Em uso'],
          data: [39, 61],
          borderWidth: 1
        }]
      },
      options: {
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  </script>
</body>

</html>