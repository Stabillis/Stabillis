<!DOCTYPE html>
<html lang="pt">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../css/nav&fotter.css">
  <link rel="stylesheet" href="../css/listaColaborador.css">
  <link rel="stylesheet" href="../css/modal.css">
  <script src="../js/colab.js" defer></script>
  <script src="../js/funcoes.js"></script>
  <title>Colaboradores</title>
</head>

<body onload="atualizarFeed(fkEmpresa)">

  <div class="nav">
    <input type="checkbox" id="nav-check">
    <div class="nav-header">
      <img style="height: 40px;" src="../assets/icon/stabilis_main_side.png" alt="">

    </div>
    <div class="nav-btn">
      <label for="nav-check">
        <span></span>
        <span></span>
        <span></span>
      </label>
    </div>

    <div class="nav-links" onclick="limparSessao()">
      <span id="login">Sair</span>
    </div>
  </div>

  <!-- pesquisar -->
  <div class="containerPesquisa">
    <p>Colaboradores</p>
  </div>
  <!-- fim  -->

  <!-- adicionar -->
  <div class="containerAdicionar">
    <a href="#">
      <img id="addColab"
        src="https://cdn-icons-png.flaticon.com/512/845/845630.png?w=740&t=st=1680896121~exp=1680896721~hmac=aeb2a168c952acf12dd77a0f485a697418e73473c5f141e5ba510e55ee4431b9"
        alt="">
    </a>

    <p>Adicionar colaborador</p>
  </div>
  <!-- fim  -->


  <div class="containerLista">

    <div>
      <table class="containerTable">
        <tr>
          <th>IDENTIFICAÇÃO</th>
          <th>NOME</th>
          <th>STATUS/PERMISSÕES</th>
          <th id="colunaEdicao">EXCLUIR/ALTERAR</th>
        </tr>
        <tr>


      </table>
    </div>
  </div>

  <!-- INICIO MODAL -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <header class="modal-header">
        <h2>Novo Colaborador</h2>
      </header>
      <span class="modal-close" id="modalClose">&#10006;</span>

      <form class="modal-form">
        <input type="text" class="modal-field" placeholder="Nome do funcionário" id="ipt_nome_usuario">
        <input type="text" class="modal-field" placeholder="Email" id="ipt_email">
      </form>

      <form class="modal-form2">
        <input type="text" class="modal-field" placeholder="Telefone Celular" id="ipt_telefone_celular">
        <input type="password" class="modal-field" placeholder="Senha" id="ipt_senha">
      </form>

      <form class="modal-form">
        <select name="" id="sel_perm">
          <option value="2">Padrão</option>
          <option value="1">Adminstrador</option>
        </select>
      </form>
      <footer class="modal-footer">
        <button class="saveButton" onclick="criarUsuario()">Salvar</button>
        <button class="cancelButton">Cancelar</button>
      </footer>
    </div>
  </div>

  <div class="modal" id="modalEdit">
    <div class="modal-content">
      <header class="modal-header">
        <h2>Novo Colaborador</h2>
      </header>
      <span class="modal-close" id="modalEditClose">&#10006;</span>

      <form class="modal-form">
        <input type="text" class="modal-field" placeholder="Nome do funcionário" id="ipt_nome_usuario_edit">
        <input type="text" class="modal-field" placeholder="Email" id="ipt_email_edit">
      </form>

      <form class="modal-form2">
        <input type="text" class="modal-field" placeholder="Telefone Celular" id="ipt_telefone_celular_edit">
        <select name="" id="sel_perm_edit">
          <option value="2">Padrão</option>
          <option value="1">Adminstrador</option>
        </select>
      </form>

      <footer class="modal-footer">
        <button class="saveButton" onclick="editarUsuario()">Salvar</button>
        <button class="cancelButton">Cancelar</button>
      </footer>
    </div>
  </div>
  <!-- FIM MODAL -->



  <!--footer inicio-->
  <footer class="padding_3x">

    <div class="flex">
      <section class="flex-content padding_1x">
        <a href="#"><i class="fa fa-facebook"></i></a>
        <a href="#"><i class="fa fa-twitter"></i></a>
        <a href="#"><i class="fa fa-linkedin"></i></a>
      </section>
      <section class="flex-content padding_1x">
        <h3>Mapa do site</h3>
        <a href="../index.html">Home</a>
        <a href="../sobre-nos.html">Sobre nós</a>
        <a href="../loginUsuario.html">Login</a>
        <a href="../cadastroEmpresa.html">Cadastro</a>
      </section>
      <section class="flex-content padding_1x">
        <h3>Quick Links</h3>
        <a href="#">Jobs</a>
        <a href="#">Brand Assets</a>
        <a href="#">Investor Relations</a>
        <a href="#">Terms of Service</a>
      </section>
      <section class="flex-content padding_1x">
        <h3>Contatos</h3>
        <a href="#">Stabillis@outlook.com.br</a>
        <a
          href="https://www.google.com/maps/dir/-23.4848464,-46.6995227/Rua+Haddock+Lobo,+593+-+Cerqueira+C%C3%A9sar,+S%C3%A3o+Paulo+-+SP,+01414-001/@-23.5213493,-46.7075957,13z/data=!3m1!4b1!4m9!4m8!1m1!4e1!1m5!1m1!1s0x94ce59d2b0377801:0x852c06561ff8743d!2m2!1d-46.6615654!2d-23.5580366">Rua
          Haddock Lobo - 593 - São Paulo SP</a>
        <a href="#">Telefone: (11) 4002-8922</a>
      </section>
      <section class="flex-content image-logo">
        <img src="assets/icon/stabilis_white_above.png" alt="">
      </section>

    </div>
    <div class="flex">


    </div>
  </footer>
  <!--footer fim-->



</body>

</html>

<script>
  var fkEmpresa = sessionStorage.FK_EMPRESA;

  // FORMATAÇÃO TELEFONE
  const telefone = document.getElementById("ipt_telefone_celular");

  telefone.addEventListener("keyup", formatarTelefone);

  function formatarTelefone(e) {

    var v = e.target.value.replace(/\D/g, "");

    v = v.replace(/^(\d\d)(\d)/g, "($1) $2");

    v = v.replace(/(\d{5})(\d)/, "$1-$2");

    e.target.value = v;

  }
  // FORMATAÇÃO TELEFONE

  const telefone2 = document.getElementById("ipt_telefone_celular_edit");

  telefone2.addEventListener("keyup", formatarTelefone);

  function formatarTelefone(e) {

    var v = e.target.value.replace(/\D/g, "");

    v = v.replace(/^(\d\d)(\d)/g, "($1) $2");

    v = v.replace(/(\d{5})(\d)/, "$1-$2");

    e.target.value = v;

  }
  // FORMATAÇÃO TELEFONE
  function limparFormulario() {
    document.getElementById("form_postagem").reset();
  }

  function criarUsuario() {
    var nomeUsuarioVar = ipt_nome_usuario.value
    var emailVar = ipt_email.value
    var telCelVar = ipt_telefone_celular.value
    var senhaVar = ipt_senha.value
    var tipoUsuarioVar = Number(sel_perm.value)
    var fkEmpresaVar = sessionStorage.FK_EMPRESA

    telCelVar = telCelVar.replace("(", "")
    telCelVar = telCelVar.replace(")", "")
    telCelVar = telCelVar.replace(" ", "")
    telCelVar = telCelVar.replace("-", "")

    if (nomeUsuarioVar == "" || emailVar == "" || telCelVar == "" || senhaVar == "") {
      alert("Preencha todos os campos para finalizar o cadastro!")

      return false;
    } else {
      console.log("Cadastrando novo usuário")
    }

    // Enviando o valor da nova input
    fetch("/usuarios/cadastrar", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        // crie um atributo que recebe o valor recuperado aqui
        // Agora vá para o arquivo routes/usuario.js
        nomeUsuarioServer: nomeUsuarioVar,
        emailServer: emailVar,
        telCelServer: telCelVar,
        senhaServer: senhaVar,
        tipoUsuarioServer: tipoUsuarioVar,
        fkEmpresaServer: fkEmpresaVar
      })
    }).then(function (resposta) {

      console.log("resposta: ", resposta);

      if (resposta.ok) {
        alert("Usuário cadastrado!")
        document.getElementById('modal').classList.remove('active')
        window.location = 'listaUsuarios.html'

        // limparFormulario();
        // finalizarAguardar();
      } else {
        throw ("Houve um erro ao tentar realizar o cadastro!");
      }
    }).catch(function (resposta) {
      console.log(`#ERRO: ${resposta}`);
      // finalizarAguardar();
    });

    return false;
  }

  function editarUsuario() {
    var idUsuario = sessionStorage.getItem('ID_USUARIO_EDITANDO')
    var nomeUsuario = ipt_nome_usuario_edit.value;
    var email = ipt_email_edit.value
    var telefone = ipt_telefone_celular_edit.value
    var permissao = Number(sel_perm_edit.value)

    console.log(idUsuario)
    if (nomeUsuario == null || email == null || telefone == null || permissao == null) {
      alert("Complete todos os campos para concluir a edição!")
    } else {
      fetch(`/usuarios/editarUsuario/${idUsuario}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          nomeUsuarioServer: nomeUsuario,
          emailServer: email,
          telefoneServer: telefone,
          permissaoServer: permissao
        })
      }).then(function (resposta) {
        if (resposta.ok) {
          alert('Usuário atualizado com sucesso!')
          document.getElementById('modalEdit').classList.remove('active')
          window.location = 'listaUsuarios.html';
        } else if (resposta.status == 500) {
          window.location = 'listaUsuarios.html';
        }
      })
    }
  }

  function editar(idUsuario) {
    sessionStorage.ID_USUARIO_EDITANDO = idUsuario;
    console.log("cliquei em editar - " + idUsuario);

    document.getElementById('modalEdit').classList.add('active')

    fetch(`/usuarios/editar/${idUsuario}`, {
      method: "GET",
      headers: {
        "Content-Type": "application/json"
      }
    }).then(function (resposta) {
      console.log("UsuarioById", resposta.body)
      resposta.json().then(json => {

        console.log(json)
        document.getElementById('ipt_nome_usuario_edit').value = json.NomeUsuario
        document.getElementById('ipt_email_edit').value = json.Email
        document.getElementById('ipt_telefone_celular_edit').value = json.TelefoneCelular
      })
    })

  }

  function estadoPerfilUsuario(idUsuario) {
    console.log("Criar função de apagar post escolhido - ID" + idUsuario);
    fetch(`/listaUsuario/estadoPerfilUsuario/${idUsuario}`, {
      method: "GET",
      headers: {
        "Content-Type": "application/json"
      }
    }).then(function (resposta) {

      if (resposta.ok) {
        console.log('entrei no segundo fetch')
        resposta.json().then(json => {
          console.log(json);
          console.log(JSON.stringify(json));
          var fkPerfil = Number(json[0].FK_Perfil)

          var idUsuario = Number(json[0].idUsuario)

          if (fkPerfil == 1) {
            fkPerfil++
          } else {
            fkPerfil--
          }
          fetch(`/listaUsuario/desativarAtivar`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              idUsuarioServer: idUsuario,
              fkPerfilServer: fkPerfil
            })
          }).then(function (resposta) {

            console.log("resposta: ", resposta);

            if (resposta.ok) {
              window.location = "listaUsuarios.html"
              // finalizarAguardar();
            } else if (resposta.status == 404) {
              window.alert("Deu 404!");
            } else {
              throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
            }
          }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
            // finalizarAguardar();
          });
          window.location = "/dashboard/listaUsuarios.html"
        });

      } else {
        console.log("Houve um erro ao tentar realizar o login!");

        resposta.text().then(texto => {
          console.error(texto);
          alert("Email e/ou Senha inválidos")
          // finalizarAguardar(texto);
        });
      }
    }).catch(function (resposta) {
      console.log(`#ERRO: ${resposta}`);
    });
  }

  function desativar(idUsuario) {
    console.log("Criar função de apagar post escolhido - ID" + idUsuario);
    fetch(`/listaUsuario/desativar/${idUsuario}`, {
      method: "DELETE",
      headers: {
        "Content-Type": "application/json"
      }
    }).then(function (resposta) {

      if (resposta.ok) {
        window.location = "/dashboard/listaUsuarios.html"
      } else if (resposta.status == 404) {
        window.alert("Deu 404!");
      } else {
        throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
      }
    }).catch(function (resposta) {
      console.log(`#ERRO: ${resposta}`);
    });
  }

  function atualizarFeed(fkEmpresa) {
    //aguardar();
    fetch("/listaUsuario/listar").then(function (resposta) {
      if (resposta.ok) {
        if (resposta.status == 204) {
          var feed = document.getElementsByClassName("table");
          var mensagem = document.createElement("span");
          mensagem.innerHTML = "Nenhum resultado encontrado."
          feed.appendChild(mensagem);
          throw "Nenhum resultado encontrado!!";
        }

        resposta.json().then(function (resposta) {
          console.log("Dados recebidos: ", JSON.stringify(resposta));

          var feed = document.querySelector('table');
          // feed.innerHTML = "";
          for (let i = 0; i < resposta.length; i++) {
            var publicacao = resposta[i];

            // criando e manipulando elementos do HTML via JavaScript
            var linhaLista = document.createElement("tr");
            var tdIdentificacao = document.createElement("td");
            var tdHostname = document.createElement("td");
            var tdStatus = document.createElement("td");
            var tdBotoes = document.createElement("td");
            var divBotoes = document.createElement("div")
            var btnEditar = document.createElement("span");
            var btnDeletar = document.createElement("span");
            console.log("elemento html criado")


            tdIdentificacao.innerHTML = `${i + 1}`
            tdHostname.innerHTML = `${publicacao.nomeUsuario}`
            if (publicacao.FK_Perfil == 1) {
              tdStatus.innerHTML = `Administrador`;
              console.log("entrando no if")

            } else if (publicacao.FK_Perfil == 2) {
              tdStatus.innerHTML = `Padrão`;
              console.log("entrando no else")

            }
            btnEditar.innerHTML = "<img src=' https://cdn-icons-png.flaticon.com/512/98/98090.png?w=826&t=st=1680890579~exp=1680891179~hmac=22fea846a60055b34d1312f83040a9785f819033e8a2d12dcf6f6a8b1dad563c' height= '25px' >";
            btnDeletar.innerHTML = "<img src='https://cdn-icons-png.flaticon.com/512/1250/1250925.png?w=826&t=st=1680890678~exp=1680891278~hmac=f51dcc26fefd6e465196cc4a4265a52fe897af469d24e6407008b67593661c69' height ='25px'>";
            console.log('elementos com conteudo criado')

            linhaLista.className = "lista-maquina";
            tdIdentificacao.id = "id-maquina" + publicacao.idUsuario;
            tdHostname.className = "lista-maquina-hostname";
            tdStatus.className = "lista-maquina-status";
            divBotoes.id = "iconesColuna";

            tdBotoes.className = "botoes-lista"

            console.log('classes atribuidas aos elementos')

            btnEditar.className = "lista-btn-editar"
            btnEditar.id = "btnEditar" + publicacao.idUsuario;
            btnEditar.setAttribute("onclick", `desativar(${publicacao.idUsuario})`);

            btnDeletar.className = "lista-btn-editar"
            btnDeletar.id = "btnDeletar" + publicacao.idUsuario;
            btnDeletar.setAttribute("onclick", `editar(${publicacao.idUsuario})`);
            console.log('botoes funcionando')

            linhaLista.appendChild(tdIdentificacao);
            linhaLista.appendChild(tdHostname);
            linhaLista.appendChild(tdStatus);
            linhaLista.appendChild(tdBotoes);
            tdBotoes.appendChild(divBotoes)
            divBotoes.appendChild(btnEditar);
            divBotoes.appendChild(btnDeletar);
            feed.appendChild(linhaLista);
          }

          // finalizarAguardar();
        });
      } else {
        throw ('Houve um erro na API!');
      }
    }).catch(function (resposta) {
      console.error(resposta);
      // finalizarAguardar();
    });
  }

  function testar() {
    aguardar();

    var formulario = new URLSearchParams(new FormData(document.getElementById("form_postagem")));

    var divResultado = document.getElementById("div_feed");

    divResultado.appendChild(document.createTextNode(formulario.get("descricao")));
    divResultado.innerHTML = formulario.get("descricao");

    finalizarAguardar();

    return false;
  }

</script>