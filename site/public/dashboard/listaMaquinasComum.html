<!DOCTYPE html>
<html lang="pt">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../css/nav&fotter.css">
  <link rel="stylesheet" href="../css/listaColaborador.css">
  <link rel="stylesheet" href="../css/modalMaq.css">
  <script src="../js/maq.js" defer></script>
  <script src="../js/funcoes.js"></script>
  <title>Máquinas</title>
</head>

<body onload="atualizarFeed(fkEmpresa)">
  <div class="nav">
    <input type="checkbox" id="nav-check">
    <div class="nav-header">
      <img style="height: 40px;" src="../assets/icon/stabilis_main_side.png" alt="">

    </div>
    <div class="nav-btn">
      <label for="nav-check">
        <span></span>
        <span></span>
        <span></span>
      </label>
    </div>

    <div class="nav-links" onclick="limparSessao()">
      <span id="login">Sair</span>
    </div>
  </div>

  <!-- pesquisar -->
  <div class="containerPesquisa">
    <p>Máquinas</p>

    <div class="input-btn">
      <!-- <input type="text" class="ipt-pesquisar" placeholder="Digitar">
      <button class="btn-pesquisar">Pesquisar</button> -->
    </div>
  </div>
  <!-- fim  -->

  <!-- adicionar -->
  <!-- <div class="containerAdicionar">
    <a href="#">
      <img id="addMaq"
        src="https://cdn-icons-png.flaticon.com/512/845/845630.png?w=740&t=st=1680896121~exp=1680896721~hmac=aeb2a168c952acf12dd77a0f485a697418e73473c5f141e5ba510e55ee4431b9"
        alt="">
    </a>

    <p>Adicionar máquina</p>
  </div> -->
  <!-- fim  -->


  <div class="containerLista">

    <table>
      <tr>
        <th>IDENTIFICAÇÃO</th>
        <th>HOSTNAME</th>
        <th>STATUS</th>
        <!-- <th id="colunaEdicao">EDITAR/PARAR</th> -->
      </tr>

    </table>

  </div>

  <div class="modal" id="modal">
    <div class="modal-content">
      <header class="modal-header">
        <h2>Nova Máquina</h2>
        <span class="modal-close" id="modalClose">&#10006;</span>
      </header>
      <form class="modal-form">
        <input type="text" class="modal-field" placeholder="Idenficação da Máquina" id="ipt_nome_maquina">
        <input type="text" class="modal-field" placeholder="Capacidade Máxima RAM" id="ipt_capacidade_ram">
        <input type="text" class="modal-field" placeholder="Capacidade Máxima disco" id="ipt_capacidade_disco">
        <input type="text" class="modal-field" placeholder="Capacidade Máxima Processador" id="ipt_capacidade_cpu">
        <input type="text" class="modal-field" placeholder="Arquitetura" id="ipt_arquitetura">
        <input type="text" class="modal-field" placeholder="Sistema Operacional" id="ipt_sistema_operacional">

      </form>
      <footer class="modal-footer">
        <button class="saveButton" onclick="criarMaquina()">Salvar</button>
        <button class="cancelButton">Cancelar</button>
      </footer>
    </div>
  </div>

  <div class="modal" id="modalEdit">
    <div class="modal-content">
      <header class="modal-header">
        <h2>Editar Máquina</h2>
        <span class="modal-close" id="modalEditClose">&#10006;</span>
      </header>
      <form class="modal-form">
        <input type="text" class="modal-field" placeholder="Idenficação da Máquina" id="ipt_nome_maquina_edit">
        <input type="text" class="modal-field" placeholder="Capacidade Máxima RAM" id="ipt_capacidade_ram_edit">
        <input type="text" class="modal-field" placeholder="Capacidade Máxima disco" id="ipt_capacidade_disco_edit">
        <input type="text" class="modal-field" placeholder="Capacidade Máxima Processador" id="ipt_capacidade_cpu_edit">
        <input type="text" class="modal-field" placeholder="Arquitetura" id="ipt_arquitetura_edit">
        <input type="text" class="modal-field" placeholder="Sistema Operacional" id="ipt_sistema_operacional_edit">

      </form>
      <footer class="modal-footer">
        <button class="saveButton" onclick="editarMaquina()">Salvar</button>
        <button class="cancelButton">Cancelar</button>
      </footer>
    </div>
  </div>

  <!--footer inicio-->

  <footer class="padding_3x">

    <div class="flex">
      <section class="flex-content padding_1x">
        <a href="#"><i class="fa fa-facebook"></i></a>
        <a href="#"><i class="fa fa-twitter"></i></a>
        <a href="#"><i class="fa fa-linkedin"></i></a>
      </section>
      <section class="flex-content padding_1x">
        <h3>Mapa do site</h3>
        <a href="../index.html">Home</a>
        <a href="../sobre-nos.html">Sobre nós</a>
        <a href="../loginUsuario.html">Login</a>
        <a href="../cadastroEmpresa.html">Cadastro</a>
      </section>
      <section class="flex-content padding_1x">
        <h3>Quick Links</h3>
        <a href="#">Jobs</a>
        <a href="#">Brand Assets</a>
        <a href="#">Investor Relations</a>
        <a href="#">Terms of Service</a>
      </section>
      <section class="flex-content padding_1x">
        <h3>Contatos</h3>
        <a href="#">Stabillis@outlook.com.br</a>
        <a
          href="https://www.google.com/maps/dir/-23.4848464,-46.6995227/Rua+Haddock+Lobo,+593+-+Cerqueira+C%C3%A9sar,+S%C3%A3o+Paulo+-+SP,+01414-001/@-23.5213493,-46.7075957,13z/data=!3m1!4b1!4m9!4m8!1m1!4e1!1m5!1m1!1s0x94ce59d2b0377801:0x852c06561ff8743d!2m2!1d-46.6615654!2d-23.5580366">Rua
          Haddock Lobo - 593 - São Paulo SP</a>
        <a href="#">Telefone: (11) 4002-8922</a>
      </section>
      <section class="flex-content image-logo">
        <img src="assets/icon/stabilis_white_above.png" alt="">
      </section>

    </div>
    <div class="flex">


    </div>
  </footer>
  <!--footer fim-->



</body>

</html>

<script>

  var fkEmpresa = sessionStorage.FK_EMPRESA;

  function limparFormulario() {
    document.getElementById("form_postagem").reset();
  }

  function criarMaquina() {
    var nomeMaquina = ipt_nome_maquina.value;
    var fkStatus = 1
    var capacidadeRAM = Number(ipt_capacidade_ram.value);
    var capacidadeDisco = Number(ipt_capacidade_disco.value);
    var capacidadeCPU = Number(ipt_capacidade_cpu.value);
    var arquitetura = ipt_arquitetura.value;
    var sistemaOperacional = ipt_sistema_operacional.value;
    var fkEmpresa = sessionStorage.FK_EMPRESA

    if (nomeMaquina == null || capacidadeRAM == null || capacidadeDisco == null || capacidadeCPU == null ||
      arquitetura == null || sistemaOperacional == null) {
      alert("Complete todos os campos para inserir uma nova máquina!")
    } else {
      fetch(`/avisos/criarMaquina/`, {
        method: "post",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          nomeMaquinaServer: nomeMaquina,
          fkStatusServer: fkStatus,
          capacidadeRAMServer: capacidadeRAM,
          capacidadeDiscoServer: capacidadeDisco,
          capacidadeCPUServer: capacidadeCPU,
          arquiteturaServer: arquitetura,
          sistemaOperacionalServer: sistemaOperacional,
          fkEmpresaServer: fkEmpresa
        })
      }).then(function (resposta) {

        console.log("resposta: ", resposta);

        if (resposta.ok) {
          window.location = 'listaMaquinas.html';
          limparFormulario();
          // finalizarAguardar();
        } else if (resposta.status == 404) {
          window.alert("Deu 404!");
        } else {
          throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
        }
      }).catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
        // finalizarAguardar();
      });
    }



    return false;

  }

  function editarMaquina() {
    var idMaquina = sessionStorage.getItem('ID_POSTAGEM_EDITANDO')
    var nomeMaquina = ipt_nome_maquina_edit.value;
    var capacidadeRAM = Number(ipt_capacidade_ram_edit.value);
    var capacidadeDisco = Number(ipt_capacidade_disco_edit.value);
    var capacidadeCPU = Number(ipt_capacidade_cpu_edit.value);
    var arquitetura = ipt_arquitetura_edit.value;
    var sistemaOperacional = ipt_sistema_operacional_edit.value;

    console.log(idMaquina)
    if (nomeMaquina == null || capacidadeRAM == null || capacidadeDisco == null || capacidadeCPU == null ||
      arquitetura == null || sistemaOperacional == null) {
      alert("Complete todos os campos para inserir uma nova máquina!")
    } else {
      fetch(`/avisos/maquinas/editar/${idMaquina}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          nomeMaquinaServer: nomeMaquina,
          capacidadeRAMServer: capacidadeRAM,
          capacidadeDiscoServer: capacidadeDisco,
          capacidadeCPUServer: capacidadeCPU,
          arquiteturaServer: arquitetura,
          sistemaOperacionalServer: sistemaOperacional
        })
      }).then(function (resposta) {
        if (resposta.ok) {
          alert('Máquina atualizada com sucesso!')
          document.getElementById('modalEdit').classList.remove('active')
          window.location = 'listaMaquinas.html';
        }
      })
    }
  }


  function editar(idMaquina) {
    sessionStorage.ID_POSTAGEM_EDITANDO = idMaquina;
    console.log("cliquei em editar - " + idMaquina);

    document.getElementById('modalEdit').classList.add('active')

    fetch(`/avisos/maquinas/${idMaquina}`, {
      method: "GET",
      headers: {
        "Content-Type": "application/json"
      }
    }).then(function (resposta) {
      console.log("MaquinaById", resposta.body)
      resposta.json().then(json => {
        var maquina = json[0]

        console.log(json)
        document.getElementById('ipt_nome_maquina_edit').value = maquina.nomeMaquina
        document.getElementById('ipt_capacidade_ram_edit').value = maquina.capacidadeMaxRAM
        document.getElementById('ipt_capacidade_disco_edit').value = maquina.capacidadeMaxDisco
        document.getElementById('ipt_capacidade_cpu_edit').value = maquina.capacidadeMaxCPU
        document.getElementById('ipt_sistema_operacional_edit').value = maquina.SistemaOperacional
        document.getElementById('ipt_arquitetura_edit').value = maquina.Arquitetura
      })
    })

  }

  function estadoMaquina(idMaquina) {
    console.log("Criar função de apagar post escolhido - ID" + idMaquina);
    fetch(`/avisos/estadoMaquina/${idMaquina}`, {
      method: "GET",
      headers: {
        "Content-Type": "application/json"
      }
    }).then(function (resposta) {

      if (resposta.ok) {
        console.log('entrei no segundo fetch')
        resposta.json().then(json => {
          console.log(json);
          console.log(JSON.stringify(json));
          var fkStatus = Number(json[0].FK_Status)
          console.log(fkStatus)
          var idMaquina = Number(json[0].idMaquina)

          if (fkStatus == 1) {
            fkStatus++
          } else {
            fkStatus--
          }
          fetch(`/avisos/desativarAtivar/`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              idMaquinaServer: idMaquina,
              fkStatusServer: fkStatus
            })
          }).then(function (resposta) {

            console.log("resposta: ", resposta);

            if (resposta.ok) {
              window.alert("Máquina com sucesso pelo usuario de ID: " + idUsuario + "!");
              // finalizarAguardar();
            } else if (resposta.status == 404) {
              window.alert("Deu 404!");
            } else {
              throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
            }
          }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
            // finalizarAguardar();
          });
          window.location = "/dashboard/listaMaquinas.html"
        });

      } else {
        console.log("Houve um erro ao tentar realizar o login!");

        resposta.text().then(texto => {
          console.error(texto);
          alert("Email e/ou Senha inválidos")
          // finalizarAguardar(texto);
        });
      }
    }).catch(function (resposta) {
      console.log(`#ERRO: ${resposta}`);
    });
  }

  function atualizarFeed(fkEmpresa) {
    //aguardar();
    fetch(`/avisos/listar/${fkEmpresa}`).then(function (resposta) {
      if (resposta.ok) {
        if (resposta.status == 204) {
          var feed = document.getElementsByClassName("table");
          var mensagem = document.createElement("span");
          mensagem.innerHTML = "Nenhum resultado encontrado."
          feed.appendChild(mensagem);
          throw "Nenhum resultado encontrado!!";
        }

        resposta.json().then(function (resposta) {
          console.log("Dados recebidos: ", JSON.stringify(resposta));

          var feed = document.querySelector('table');
          // feed.innerHTML = "";
          for (let i = 0; i < resposta.length; i++) {
            var publicacao = resposta[i];
            console.log(publicacao)
            // criando e manipulando elementos do HTML via JavaScript
            var linhaLista = document.createElement("tr");
            var tdIdentificacao = document.createElement("td");
            var tdHostname = document.createElement("td");
            var tdStatus = document.createElement("td");
            var tdBotoes = document.createElement("td");
            var divBotoes = document.createElement("div")
            var btnEditar = document.createElement("span");
            var btnDeletar = document.createElement("span");
            console.log("elemento html criado")


            tdIdentificacao.innerHTML = `${publicacao.idMaquina}`
            tdHostname.innerHTML = `${publicacao.nomeMaquina}`
            if (publicacao.FK_Status == 1) {
              tdStatus.innerHTML = `Ativo`;
              console.log("entrando no if")

            } else if (publicacao.FK_Status == 2) {
              tdStatus.innerHTML = `Inativo`;
              console.log("entrando no else")

            }

            btnEditar.innerHTML = "<img src='https://cdn-icons-png.flaticon.com/512/61/61456.png?w=360' height='25px'>"
            btnDeletar.innerHTML = "<img src='https://cdn-icons-png.flaticon.com/512/151/151859.png?w=826&t=st=1680892996~exp=1680893596~hmac=b015e23e12dbbbca373f0c1d28cc32d141540cb8f3d89725e9798b7b31fbc0eb' height='25px'>";
            console.log('elementos com conteudo criado')

            if (publicacao.FK_Status == 1) {
              btnDeletar.innerHTML = "<img src='https://cdn-icons-png.flaticon.com/512/151/151859.png?w=826&t=st=1680892996~exp=1680893596~hmac=b015e23e12dbbbca373f0c1d28cc32d141540cb8f3d89725e9798b7b31fbc0eb' height='25px'>";

            } else {
              btnDeletar.innerHTML = "<img src='https://imagensemoldes.com.br/wp-content/uploads/2020/08/Figura-Play-PNG.png' height='25px'>";
            }



            linhaLista.className = "lista-maquina";
            tdIdentificacao.id = "id-maquina" + publicacao.idMaquina;
            tdHostname.className = "lista-maquina-hostname";
            tdStatus.className = "lista-maquina-status";
            divBotoes.id = "iconesColuna";

            tdBotoes.className = "botoes-lista"

            console.log('classes atribuidas aos elementos')

            btnEditar.className = "lista-btn-editar"
            btnEditar.id = "btnEditar" + publicacao.idMaquina;
            btnEditar.setAttribute("onclick", `editar(${publicacao.idMaquina})`);


            btnDeletar.className = "lista-btn-editar"
            btnDeletar.id = "btnDeletar" + publicacao.idMaquina;
            btnDeletar.setAttribute("onclick", `estadoMaquina(${publicacao.idMaquina})`);
            console.log('botoes funcionando')

            linhaLista.appendChild(tdIdentificacao);
            linhaLista.appendChild(tdHostname);
            linhaLista.appendChild(tdStatus);
            linhaLista.appendChild(tdBotoes);
            tdBotoes.appendChild(divBotoes)
            divBotoes.appendChild(btnEditar);
            divBotoes.appendChild(btnDeletar);
            console.log('final')
            feed.appendChild(linhaLista);
          }

          // finalizarAguardar();
        });
      } else {
        throw ('Houve um erro na API!');
      }
    }).catch(function (resposta) {
      console.error(resposta);
      // finalizarAguardar();
    });
  }

  function testar() {
    aguardar();

    var formulario = new URLSearchParams(new FormData(document.getElementById("form_postagem")));

    var divResultado = document.getElementById("div_feed");

    divResultado.appendChild(document.createTextNode(formulario.get("descricao")));
    divResultado.innerHTML = formulario.get("descricao");

    finalizarAguardar();

    return false;
  }

</script>