<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="dashmaquina.css">
  <title>Document</title>
</head>

<body>
  <!DOCTYPE html>
  <html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.4/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../css/dash.css">
    <script src="../js/funcoes.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  </head>

  <body>
    <nav class="side-menu" id="sideMenu">


      <ul>
        <li class="itens-menu">
          <a href="perfilUsuario.html">
            <span class="icon"><i class="bi bi-person"></i></span>
            <span class="txt">Perfil</span>
          </a>
        </li>
        <li class="itens-menu">
          <a href="../suporte.html">
            <span class="icon"><i class="bi bi-columns-gap"></i></span>
            <span class="txt">Suporte</span>
          </a>
        </li>
        <li class="itens-menu">
          <a href="../recuperacaoSenha.html">
            <span class="icon"><i class="bi bi-gear"></i></span>
            <span class="txt">Alterar Senha</span>
          </a>
        </li>
        <li class="itens-menu">
          <a href="../index.html">
            <span class="icon"><i class="bi bi-house"></i></span>
            <span class="txt">Sair</span>
          </a>
        </li>
    </nav>


    <div class="container">

      <div class="box1">
        <h3 class="title">Máquina: IP35015686</h3>

        <div class="graphic1"></div>
        <div class="graphic2"></div>
        <div class="graphic3"></div>


      </div>


      <div class="box1">
        <h3 class="title">Máquina: IP35015686</h3>
        <div class="graphic1"></div>
        <div class="graphic2"></div>
        <div class="graphic3"></div>


      </div>


      <div class="box1">
        <h3 class="title">Máquina: IP35015686</h3>
        <div class="graphic1"></div>
        <div class="graphic2"></div>
        <div class="graphic3"></div>


      </div>


      <div class="box1">
        <h3 class="title">Máquina: IP35015686</h3>
        <div class="graphic1"></div>
        <div class="graphic2"></div>
        <div class="graphic3"></div>


      </div>


      <div class="box1">
        <h3 class="title">Máquina: IP35015686</h3>
        <div class="graphic1"></div>
        <div class="graphic2"></div>
        <div class="graphic3"></div>


      </div>


      <div class="box1">
        <h3 class="title">Máquina: IP35015686</h3>
        <div class="graphic1"></div>
        <div class="graphic2"></div>
        <div class="graphic3"></div>


      </div>


      <div class="box1">
        <h3 class="title">Máquina: IP35015686</h3>
        <div class="graphic1"></div>
        <div class="graphic2"></div>
        <div class="graphic3"></div>


      </div>


    </div>
    </div>
    </div>
    </div>
    </div>
    </div>
    </div>
























    <script>
      var fkEmpresa = sessionStorage.FK_EMPRESA
      var naoExisteGrafico = false
      var chartData, chartData3, chartData4, chartData5

      window.onload = atualizarSelectBox(fkEmpresa);

      function obterDadosGraficos() {
        var select = document.getElementById('sel_maq')
        var value = select.options[select.selectedIndex].value

        if (value == '#') {
          alert("Escolha uma máquina!")
        } else {
          obterdadosGrafico(value)
        }
      }

      function atualizarSelectBox(fkEmpresa) {
        fetch(`/avisos/listarMaquinas/${fkEmpresa}`).then(function (resposta) {
          if (resposta.ok) {
            if (resposta.status == 204) {
              alert('Não há máquinas cadastradas!')
              throw "Nenhum resultado encontrado!!";
            }

            resposta.json().then(function (resposta) {
              console.log("Dados recebidos: ", JSON.stringify(resposta));

              var feed = document.getElementById('sel_maq');
              // feed.innerHTML = "";
              for (let i = 0; i < resposta.length; i++) {
                var publicacao = resposta[i];

                // criando e manipulando elementos do HTML via JavaScript
                var opcao = document.createElement('option')
                opcao.innerHTML = `${publicacao.nomeMaquina}`
                opcao.id = "maquina-" + publicacao.idMaquina
                opcao.value = `${publicacao.idMaquina}`
                feed.appendChild(opcao)
                // console.log("elemento html criado")
                feed.appendChild(opcao);
              }


              // finalizarAguardar();
            });
          } else {
            throw ('Houve um erro na API!');
          }
        }).catch(function (resposta) {
          console.error(resposta);
          // finalizarAguardar();
        });
      }

      function obterdadosGrafico(idMaquina) {

        fetch(`/medidas/ultimas/${idMaquina}`, { cache: 'no-store' }).then(function (response) {
          if (response.ok) {
            response.json().then(function (resposta) {
              console.log(`dados recebidos: ${JSON.stringify(resposta)}`);
              resposta.reverse();

              plotarGrafico(resposta, idMaquina);

            });
          } else {
            console.error('Nenhum dado encontrado ou erro na API');
          }
        })
          .catch(function (error) {
            console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
          });
      }

      // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
      // Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
      // A função *plotarGrafico* também invoca a função *atualizarGrafico*
      function plotarGrafico(resposta, idMaquina) {
        console.log('Iniciando plotagem do gráfico...');

        if (naoExisteGrafico) {
          console.log("destruindo graficos")
          naoExisteGrafico = false
          chartData.destroy()
          chartData3.destroy()
          chartData4.destroy()
          chartData5.destroy()
          plotarGrafico(resposta, idMaquina)
        } else {
          naoExisteGrafico = true

          const ctx = document.getElementById('grafico');
          let labels = [];

          chartData = new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: 'Bytes enviados',
                data: [],
                borderWidth: 1
              }, {
                label: 'Bytes recebidos',
                data: [],
                borderWidth: 1
              }]
            },
            options: {
              scales: {
                y: {
                  beginAtZero: true
                }
              }
            }
          });
          // termino grafico 1 
          const ctx3 = document.getElementById('grafico3');

          chartData3 = new Chart(ctx3, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: 'Uso em %',
                data: [],
                borderWidth: 1
              }]
            },
            options: {
              scales: {
                y: {
                  beginAtZero: true
                }
              }
            }
          });

          const ctx4 = document.getElementById('grafico4');

          chartData4 = new Chart(ctx4, {
            type: 'pie',
            data: {
              labels: ['% Em uso', '% Disponível'],
              datasets: [{
                label: [],
                data: [],
                borderWidth: 1,
                backgroundColor: ['#8C4356', '#27628A']
              }]
            },
            options: {
              scales: {
                y: {
                  beginAtZero: true
                }
              }
            }
          });

          const ctx5 = document.getElementById('grafico5');

          chartData5 = new Chart(ctx5, {
            type: 'pie',
            data: {
              labels: ['% Em uso', '% Disponível'],
              datasets: [{
                label: [],
                data: [],
                borderWidth: 1,
                backgroundColor: ['#8C4356', '#27628A']
              }]
            },
            options: {
              scales: {
                y: {
                  beginAtZero: true
                }
              }
            }
          });

          for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            // console.log(registro);
            //começando envio de dados do pacote
            var dadoBytesEnviados = registro.bytesEnviados
            var valorBytesEnviados = Number((dadoBytesEnviados.slice(0, 3)).replace(",", "."))
            var medidaBytesEnviados = dadoBytesEnviados.slice(3)

            var dadoBytesRecebidos = registro.bytesRecebidos
            var valorBytesRecebidos = Number((dadoBytesRecebidos.slice(0, 3)).replace(",", "."))
            var medidaBytesRecebidos = dadoBytesRecebidos.slice(3)


            chartData.data.datasets[0].data.push(valorBytesEnviados);
            chartData.data.datasets[1].data.push(valorBytesRecebidos);
            //terminando envio de dados do pacote
            chartData3.data.datasets[0].data.push(registro.usoCPU);

            labels.push(registro.dh)
          }
          chartData4.data.datasets[0].data.push(resposta[0].usoRAM);
          chartData4.data.datasets[0].data.push(resposta[0].capacidadeMaxRAM - resposta[0].usoRAM);

          chartData5.data.datasets[0].data.push(resposta[0].usoDisco);
          chartData5.data.datasets[0].data.push(resposta[0].capacidadeMaxDisco - resposta[0].usoDisco);

          var tempo_atividade = document.getElementById("tempo-atividade")
          tempo_atividade.innerHTML = `${(resposta[0].tempoAtividade).replace("days", "dias")}`

          chartData.resize()
          chartData3.resize()

          //setTimeout(() => atualizarGrafico(idMaquina, chartData, chartData3,
          //  chartData4, chartData5), 2000);
          chartData.update();
          chartData3.update();
          chartData4.update();
          chartData5.update();
        }

      }

      function atualizarGrafico(idMaquina, chartData, chartData3,
        chartData4, chartData5) {



        fetch(`/medidas/tempo-real/${idMaquina}`, { cache: 'no-store' }).then(function (response) {
          if (response.ok) {
            response.json().then(function (novoRegistro) {

              console.log(`dados recebidos: ${JSON.stringify(novoRegistro)}`);
              console.log(`dados atuais do gráfico:`);
              //console.log(dados);

              // let avisoCaptura = document.getElementById(`avisoCaptura${idMaquina}`)
              // avisoCaptura.innerHTML = ""


              if (novoRegistro[0].dh == chartData.data.labels[chartData.data.labels.length - 1] && novoRegistro[0].dh == chartData3.data.labels[chartData3.data.labels.length - 1]) {
                console.log("---------------------------------------------------------------")
                console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                //avisoCaptura.innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
                console.log("Horário do novo dado capturado:")
                console.log(novoRegistro[0].dh)
                console.log("Horário do último dado capturado:")
                console.log(chartData.data.labels[chartData.data.labels.length - 1])
                console.log(chartData3.data.labels[chartData3.data.labels.length - 1])
                console.log("---------------------------------------------------------------")
              } else {
                // tirando e colocando valores no gráfico
                chartData.data.labels.shift();
                chartData3.data.labels.shift(); // apagar o primeiro
                chartData.data.labels.push(novoRegistro[0].dh);
                chartData3.data.labels.push(novoRegistro[0].dh); // incluir um novo momento

                chartData.data.datasets[0].data.shift();  // apagar o primeiro de umidade
                chartData.data.datasets[0].data.push(novoRegistro[0].BytesRecebidos); // incluir uma nova medida de umidade

                chartData.data.datasets[1].data.shift();  // apagar o primeiro de temperatura
                chartData.data.datasets[1].data.push(novoRegistro[0].BytesEnviados); // incluir uma nova medida de 
                chartData4.data.datasets[0].data.shift();  // apagar o primeiro de temperatura
                chartData4.data.datasets[0].data.push(novoRegistro[0].usoRAM); // incluir uma nova medida de temperatura
                chartData3.data.datasets[0].data.shift();  // apagar o primeiro de temperatura
                chartData3.data.datasets[0].data.push(novoRegistro[0].usoCPU); // incluir uma nova medida de temperatura
                chartData5.data.datasets[0].data.shift();  // apagar o primeiro de temperatura
                chartData5.data.datasets[0].data.push(novoRegistro[0].usoDisco); // incluir uma nova medida de temperatura

                var tempo_atividade = document.getElementById('tempo-atividade')
                tempo_atividade.innerHTML = `${(novoRegistro[0].tempoAtividade).replace('days', 'dias')}`

                chartData.update();
                chartData3.update();
                chartData4.update();
                chartData5.update();
              }

              // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
              proximaAtualizacao = setTimeout(() => atualizarGrafico(idMaquina, chartData, chartData3,
                chartData4, chartData5), 1000);
            });
          } else {
            console.error('Nenhum dado encontrado ou erro na API');
            // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
            proximaAtualizacao = setTimeout(() => atualizarGrafico(idMaquina, chartData, chartData3,
              chartData4, chartData5), 2000);
          }
        })
          .catch(function (error) {
            console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
          });

      }

      function converterBytes(bytes) {
        const unidades = ['Bytes', 'KiB', 'MiB', 'GiB', 'TiB'];
        const base = 1024;
        if (bytes === 0) return '0 Bytes';
        const exp = Math.floor(Math.log(bytes) / Math.log(base));
        const tamanho = (bytes / Math.pow(base, exp)).toFixed(1);
        const unidade = unidades[exp];
        return tamanho + ' ' + unidade;
      }

    </script>
  </body>

  </html>

</body>

</html>